from guardian import GuardState
from guardian import GuardStateDecorator
from guardian import NodeManager
import os
import sys


userapps = '/opt/rtcds/userapps/release/'
IFO = os.getenv('IFO')
ifo = IFO.lower()
SITE = os.getenv('SITE')
site = SITE.lower()
dorw = 2
verbose=False

def modelName(optic):
    return ifo+'vis'+optic

def req_file_path(optic):
    return os.path.join('/opt/rtcds',site,ifo,'target',modelName(optic),modelName(optic)+'epics')

def snap_file_path(optic):
#    return os.path.join(userapps, 'vis', ifo, 'burtfiles') 
    return os.path.join(userapps, 'vis', ifo, 'guardian') # FIXME temporary only

#reqfile = req_file_path(optic)
#snapfile = snap_file_path(optic)

#reqfile = req_file_path(optic)+'/autoBurt.req'
#snapfile = '/opt/rtcds/userapps/release/vis/k1/burtfiles/'+modelName(optic)+'_guardian_safe.snap'

###################################################


# utility functions

def is_tripped():
    if (ezca['VIS-'+optic+'_TM_WDMON_STATE'] != 1) or \
	(ezca['VIS-'+optic+'_IM_WDMON_STATE'] != 1) or \
	(ezca['VIS-'+optic+'_BF_WDMON_STATE'] != 1) or \
	(ezca['VIS-'+optic+'_SF_WDMON_STATE'] != 1): # if WatchDog is triped
        return True

    else:
        return False

def is_pretripped():
        if ezca['VIS-'+optic+'_IM_WD_OSEMAC_V1_RMSMON'] > 2000.0:
                return True
        elif ezca['VIS-'+optic+'_IM_WD_OSEMAC_V2_RMSMON'] > 2000.0:
                return True
        elif ezca['VIS-'+optic+'_IM_WD_OSEMAC_V3_RMSMON'] > 2000.0:
                return True
        elif ezca['VIS-'+optic+'_IM_WD_OSEMAC_H1_RMSMON'] > 2000.0:
                return True
        elif ezca['VIS-'+optic+'_IM_WD_OSEMAC_H2_RMSMON'] > 2000.0:
                return True
        elif ezca['VIS-'+optic+'_IM_WD_OSEMAC_H3_RMSMON'] > 2000.0:
                return True
        elif ezca['VIS-'+optic+'_BF_WD_AC_LVDT_V1_RMSMON'] > 100.0:
                return True
        elif ezca['VIS-'+optic+'_BF_WD_AC_LVDT_V2_RMSMON'] > 100.0:
                return True
        elif ezca['VIS-'+optic+'_BF_WD_AC_LVDT_V3_RMSMON'] > 100.0:
                return True
        elif ezca['VIS-'+optic+'_BF_WD_AC_LVDT_H1_RMSMON'] > 100.0:
                return True
        elif ezca['VIS-'+optic+'_BF_WD_AC_LVDT_H2_RMSMON'] > 100.0:
                return True
        elif ezca['VIS-'+optic+'_BF_WD_AC_LVDT_H3_RMSMON'] > 100.0:
                return True
        elif ezca['VIS-'+optic+'_SF_WD_AC_GAS_RMSMON'] > 100.0:
                return True
	else:
	        return False


def tm_damp_off():
    for DOF in ['L', 'P', 'Y']:
        ezca['VIS-'+optic+'_TM_DAMP_%s_TRAMP'%DOF] = 10.0
        ezca['VIS-'+optic+'_TM_DAMP_%s_GAIN'%DOF] = 0
    #time.sleep(10) # FIXME! no sleeping command.
    for DOF in ['PIT','YAW']:
        ezca['VIS-'+optic+'_TM_OPLEV_SERVO_%s_TRAMP'%DOF] = 3.0
        ezca['VIS-'+optic+'_TM_OPLEV_SERVO_%s_GAIN'%DOF] = 0.0
        ezca.switch('VIS-'+optic+'_TM_OPLEV_SERVO_%s'%DOF,'FM1','OFF')
    
def im_damp_off():
    for DOF in ['L','T','V','R','P','Y']:
        ezca['VIS-'+optic+'_IM_DAMP_%s_TRAMP'%DOF] = 5.0
        ezca['VIS-'+optic+'_IM_DAMP_%s_GAIN'%DOF] = 0

def im_oldamp_off():
    for DOF in ['P','Y']:
        ezca['VIS-'+optic+'_IM_OLDAMP_%s_TRAMP'%DOF] = 10.0
        ezca['VIS-'+optic+'_IM_OLDAMP_%s_GAIN'%DOF] = 0


def bf_damp_off():
    for DOF in ['L','T','V','R','P','Y']:
        ezca['VIS-'+optic+'_BF_DAMP_%s_TRAMP'%DOF] = 5.0
        ezca['VIS-'+optic+'_BF_DAMP_Y_TRAMP'] = 10.0
        ezca['VIS-'+optic+'_BF_DAMP_%s_GAIN'%DOF] = 0

def gas_damp_off():
    for DOF in ['BF','SF']:
        ezca['VIS-'+optic+'_%s_DAMP_GAS_TRAMP'%DOF] = 10.0
        ezca['VIS-'+optic+'_%s_DAMP_GAS_GAIN'%DOF] = 0


def test_off():
    for DOF in ['L', 'P', 'Y']:
        ezca['VIS-'+optic+'_TM_TEST_%s_TRAMP'%DOF] = 5.0
        ezca['VIS-'+optic+'_TM_TEST_%s_GAIN'%DOF] = 0
    for DOF in ['L','T','V','R','P','Y']:
        ezca['VIS-'+optic+'_IM_TEST_%s_TRAMP'%DOF] = 5.0
        ezca['VIS-'+optic+'_IM_TEST_%s_GAIN'%DOF] = 0
    for DOF in ['L','T','V','R','P','Y']:
        ezca['VIS-'+optic+'_BF_TEST_%s_TRAMP'%DOF] = 5.0
        ezca['VIS-'+optic+'_BF_TEST_%s_GAIN'%DOF] = 0
    for DOF in ['BF','SF']:
        ezca['VIS-'+optic+'_%s_TEST_GAS_TRAMP'%DOF] = 10.0
        ezca['VIS-'+optic+'_%s_TEST_GAS_GAIN'%DOF] = 0

def all_off():
    tm_damp_off()
    im_oldamp_off()
    #time.sleep(10)
    test_off()
    im_damp_off()
    bf_damp_off()
    gas_damp_off()
    #time.sleep(10)
